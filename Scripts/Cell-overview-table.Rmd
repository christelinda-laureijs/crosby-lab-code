---
title: "Cell Overview Table"
output:
  html_document:
    css: "../Templates/my-CSS-theme.css"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)

source(
  here::here("Scripts/Libraries.R"),
  local = knitr::knit_global(),
  echo = FALSE,
  verbose  = FALSE
)

source(here("Scripts/Functions.R"), local = knitr::knit_global())
source(here("Templates/Theme-options.R"), local = knitr::knit_global())


save_RDS_files <- "no"
```

# Number of cells

```{r}
characteristics <- read.csv(here("Data/Sample-cell-characteristics.csv"), header=T) %>% 
  rename_with(str_to_title)

```

```{r}
characteristics %>%
  group_by(Treatment, Sex, Category) %>%
  summarize('Number of cells' = n()) %>%
  reactable(
    columns = list('Number of cells' = colDef(
      style = function(value) {
        if (value < 7) {
          color <- "#950606"
        } else {
          color <- "#000000"
        }
        list(color = color, fontWeight = "bold")
      }
    )),
    highlight = TRUE
  )
```


# Cell Information

```{r}
characteristics %>%
  rename_with(str_to_title) %>%
  reactable(
    filterable = TRUE,
    columns = list(
      Letter = colDef(
        sticky = "left",
        style = list(borderRight = "1px solid #eee"),
        headerStyle = list(borderRight = "1px solid #eee")
      ),
      Sex = colDef(
        filterable = TRUE,
        filterMethod = JS(
          "function(rows, columnId, filterValue) {
        return rows.filter(function(row) {
          return String(row.values[columnId]) === filterValue
        })
      }"
        )
      )
    ),
    showPageSizeOptions = TRUE
  )
```


```{r}
make_normalized_EPSC_data(filename = "Data/Sample-eEPSC-data.csv",
                          current_type = "eEPSC",
                          min_time_value = 0,
                          max_time_value = 25,
                          interval_length = 5,
                          baseline_length = 5)
make_pruned_EPSC_data(data = raw_eEPSC_df,
                      current_type = "eEPSC",
                      min_time_value = 0,
                      max_time_value = 25,
                      baseline_length = 5,
                      interval_length = 1)

raw_eEPSC_df_for_table <- pruned_eEPSC_df_individual_cells %>%
  group_by(letter) %>% 
  summarize(P1_transformed = list(mean_P1))

make_normalized_EPSC_data(filename = "Data/Sample-sEPSC-data.csv",
                          current_type = "sEPSC",
                          min_time_value = 0,
                          max_time_value = 25,
                          interval_length = 5,
                          baseline_length = 5)
make_pruned_EPSC_data(data = raw_sEPSC_df,
                      current_type = "sEPSC",
                      min_time_value = 0,
                      max_time_value = 25,
                      baseline_length = 5,
                      interval_length = 1)

raw_sEPSC_df_for_table <- pruned_sEPSC_df_individual_cells %>% 
  group_by(letter) %>% 
  summarize(amplitude_transformed = list(mean_amplitude))

cell_characteristics <- read.csv(here("Data/sample-cell-characteristics.csv"))
table_data <-
  merge(raw_eEPSC_df_for_table, raw_sEPSC_df_for_table, by = "letter") %>%
  merge(., cell_characteristics, by = "letter") %>%
  merge(., treatment_names_and_colours, by = "treatment") %>%
  rename(
    treatment = display_names
  ) %>% 
  select(
    c(
      letter,
      treatment,
      synapses,
      sex,
      P1_transformed,
      amplitude_transformed,
      X,
      Y,
      age,
      animal,
      category,
      cell,
      colours
    )
  ) %>%
  rename_with(str_to_title) %>% 
  mutate(across(c(X, Y), round, -1))


```

```{r}
reactable(
  data = table_data,
  defaultSorted = c("Category", "Treatment", "Animal"),
  filterable = TRUE,
  showPageSizeOptions = TRUE,
  defaultPageSize = 15,
  defaultColDef = colDef(
    vAlign = "center",
    headerVAlign = "center"
  ),
  columns = list(
    Colours = colDef(show = FALSE),
    Letter = colDef(
      sticky = "left",
      style = list(borderRight = "1px solid #eee"),
      headerStyle = list(borderRight = "1px solid #eee")
    ),
    Sex = colDef(
      filterable = TRUE,
      filterMethod = JS(
        "function(rows, columnId, filterValue) {
        return rows.filter(function(row) {
          return String(row.values[columnId]) === filterValue
        })
      }"
      )
    ),
    P1_transformed = colDef(
      name = "eEPSC amplitude (pA)",
      filterable = FALSE,
      cell = react_sparkline(
        table_data,
        line_color_ref = "Colours",
        show_area = TRUE,
        area_opacity = 1
      )
    ),
    Amplitude_transformed = colDef(
      name = "sEPSC amplitude (pA)",
      filterable = FALSE,
      cell = react_sparkline(
        table_data,
        line_color_ref = "Colours",
        show_area = TRUE,
        area_opacity = 1
      )
    )
  )
)

knitr::knit_exit()
```


```{r}
knitr::knit_exit()
```

```{r}
characteristics %>% 
  mutate(
    image = sprintf("%s.png", letter)
  )
```



```{r}
characteristics %>%
  rename_with(str_to_title) %>%
  
  reactable(columns = list(
    Sex = colDef(filterable = TRUE),
    filterMethod = JS(
      "function(rows, columnId, filterValue ) {
                                           return rows.filter(function(row) {
                                           return String(row.values[columnId]) === filterValue
                                           })
                                           }"
    )
  ),
  searchable = TRUE)
```


```{r}
knitr::knit_exit()
```


```{r}
characteristics$image = include_graphics(here(
    paste0(
      "Figures/Evoked-currents/Output-individual-plots/",
      characteristics$letter,
      ".png"
    )
  ))
characteristics %>% 
  kable()
```

