---
title: "Cell Summary Tables"
output:
  html_document:
    css: "../Templates/my-CSS-theme.css"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)

source(
  here::here("Scripts/Libraries.R"),
  local = knitr::knit_global(),
  echo = FALSE,
  verbose  = FALSE
)

source(here("Scripts/Functions.R"), local = knitr::knit_global())
source(here("Templates/Theme-options.R"), local = knitr::knit_global())


save_RDS_files <- "no"
```


```{css increase-div-width}
div.main-container {
  max-width: 1400px !important;
}

```

# Number of cells

```{r cell-count-table}
cell_characteristics <- read.csv(here("Data/sample-cell-characteristics.csv")) %>% 
  mutate(
    R_a = lapply(str_split(R_a, pattern = ", "), FUN = as.numeric)
  )
```


```{r cell-characteristics-table}
cell_characteristics %>%
  rename_with(str_to_title) %>% 
  group_by(Treatment, Sex, Category) %>%
  summarize('Number of cells' = n()) %>%
  reactable(
    columns = list('Number of cells' = colDef(
      style = function(value) {
        if (value < 7) {
          color <- "#950606"
        } else {
          color <- "#000000"
        }
        list(color = color, fontWeight = "bold")
      }
    )),
    highlight = TRUE
  )
```

# Cell Information

```{r import-current-data}
# Import and process evoked current data
make_normalized_EPSC_data(filename = "Data/Sample-eEPSC-data.csv",
                          current_type = "eEPSC",
                          min_time_value = 0,
                          max_time_value = 25,
                          interval_length = 5,
                          baseline_length = 5)
make_pruned_EPSC_data(data = raw_eEPSC_df,
                      current_type = "eEPSC",
                      min_time_value = 0,
                      max_time_value = 25,
                      baseline_length = 5,
                      interval_length = 1)

raw_eEPSC_df_for_table <- pruned_eEPSC_df_individual_cells %>%
  group_by(letter) %>% 
  summarize(P1_transformed = list(mean_P1))

# Import and process spontaneous current data
make_normalized_EPSC_data(filename = "Data/Sample-sEPSC-data.csv",
                          current_type = "sEPSC",
                          min_time_value = 0,
                          max_time_value = 25,
                          interval_length = 5,
                          baseline_length = 5)
make_pruned_EPSC_data(data = raw_sEPSC_df,
                      current_type = "sEPSC",
                      min_time_value = 0,
                      max_time_value = 25,
                      baseline_length = 5,
                      interval_length = 1)

raw_sEPSC_df_for_table <- pruned_sEPSC_df_individual_cells %>% 
  group_by(letter) %>% 
  summarize(spont_amplitude_transformed = list(mean_amplitude))
```



```{r merge-dataframes-for-table}
# Merge dataframes for table
table_data <-
  merge(raw_eEPSC_df_for_table, raw_sEPSC_df_for_table, by = "letter") %>%
  merge(., cell_characteristics, by = "letter") %>%
  merge(., treatment_names_and_colours, by = "treatment") %>%
  select(
    c(
      letter,
      display_names,
      synapses,
      sex,
      P1_transformed,
      spont_amplitude_transformed,
      R_a,
      X,
      Y,
      age,
      animal,
      category,
      cell,
      colours
    )
  ) %>%
  rename(
    treatment = display_names
  ) %>% 
  rename_with(str_to_title) %>% 
  mutate(across(c(X, Y), round, -1))
```

```{r dropdown-function}
# created from this blog article https://albert-rapp.de/posts/18_connecting_reactable_ojs/18_connecting_reactable_ojs
filter_fct <- function(values, name) {
  tags$select(
    tags$option(value = "", "All"),
    purrr::map(unique(values), tags$option),
    onchange = glue::glue(
      "Reactable.setFilter(
        'master-cell-table', 
        '{name}', 
        event.target.value  // This is the value of the dropdown menu
      )"
    )
  )
}
```

```{r make-master-table}
reactable(
  data = table_data,
  defaultSorted = c("Category", "Treatment", "Animal"),
  filterable = TRUE,
  showPageSizeOptions = TRUE,
  elementId = "master-cell-table",
  defaultPageSize = 15,
  defaultColDef = colDef(
    vAlign = "center",
    headerVAlign = "center"
  ),
  columns = list(
    Colours = colDef(show = FALSE),
    Letter = colDef(
      name = "Letter",
      sticky = "left",
      style = list(borderRight = "1px solid #eee"),
      headerStyle = list(borderRight = "1px solid #eee")
    ),
    Treatment = colDef(
      name = "Treatment"
    ),
    Sex = colDef(
      name = "Sex",
      filterMethod = JS(
        "function(rows, columnId, filterValue) {
        return rows.filter(function(row) {
          return String(row.values[columnId]).toUpperCase() === filterValue.toUpperCase()
        })
      }"
      )
    ),
    P1_transformed = colDef(
      name = "eEPSC amplitude (pA)",
      filterable = FALSE,
      cell = react_sparkline(
        table_data,
        line_color_ref = "Colours",
        show_area = TRUE,
        area_opacity = 1
      )
    ),
    Spont_amplitude_transformed = colDef(
      name = "sEPSC amplitude (pA)",
      filterable = FALSE,
      cell = react_sparkline(
        table_data,
        line_color_ref = "Colours",
        show_area = TRUE,
        area_opacity = 1
      )
    ),
    R_a = colDef(
      name = "Ra (MÎ©)",
      filterable = FALSE,
      cell = react_sparkline(
        table_data,
        line_color_ref = "Colours",
        labels = c("first", "last"),
        decimals = 1
      )
    )
  )
)
```

